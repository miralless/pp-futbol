<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PP Football">
  <link rel="manifest" href="/db-futbol/manifest.json">
  <link rel="apple-touch-icon" href="icono.png">
  <title>Detalle del Jugador</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* ... (Tus estilos se mantienen iguales) ... */
    .content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 25px;
      padding: 20px;
      width: 100%;
    }
    .fila {
      display: flex;
      gap: 20px;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
    }
    .info-box, .stat-item {
      background-color: #1a1a1a;
      color: white;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      flex: 1;
    }
    .info-box { height: 90px; display: flex; align-items: center; justify-content: center; background-color: #292929; }
    .stat-item { height: fit-content; padding-top: 5%; background-color: #444444; }
    h2 { margin: 0; font-size: 1.3rem; }
    .point { cursor: pointer; }
    @media (min-width: 600px) { .stat-item { padding-bottom: 5%; } }
  </style>
</head>
<body>
<header class="navbar">
  <h1 class="logo">PP Football 2025/26</h1>
  <nav class="menu">
    <a href="index.html">Inicio</a>
    <a href="equipos.html">Equipos</a>
  </nav>
</header>

<div class="content"></div>

<footer class="footer">
  <p>© 2025 PP Football. Todos los derechos reservados.</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { firebaseConfig } from "./firebaseConfig.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ==== MAPEO DE IDS A NOMBRES REALES ====
const mapeoJugadores = {
  "01": "Ekain Etxebarria",
  "02": "Jon García",
  "03": "Jon Hermida",
  "04": "Eneko Ebro",
  "05": "Peio Manrique",
  "06": "Gaizka Miralles"
};

// ==== OBTENER ID NUMÉRICO DESDE LA URL ====
const params = new URLSearchParams(window.location.search);
const idNumerico = params.get("id"); // Ejemplo: "01"

// Función para generar el ID del documento (jugador_nombre_apellido)
const crearIdDoc = (tipo, nombre) => {
    return `${tipo}_${nombre.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
};

async function cargarDetalle() {
  const contenedor = document.querySelector(".content");
  const nombreReal = mapeoJugadores[idNumerico];

  if (!idNumerico || !nombreReal) {
    contenedor.innerHTML = `<p>Error: ID de jugador no reconocido.</p>`;
    return;
  }

  const docStatsId = crearIdDoc("jugador", nombreReal);
  const refStats = doc(db, "seguimiento_futbol", docStatsId);
  const refPersona = doc(db, "Personas", idNumerico);
  
  try {
    // 1. Cargamos el jugador y sus estadísticas
    const [snapStats, snapPersona] = await Promise.all([
      getDoc(refStats),
      getDoc(refPersona)
    ]);

    if (snapStats.exists() && snapPersona.exists()) {
      const dataStats = snapStats.data();
      const dataPersona = snapPersona.data();

      // === Fila 1: Nombre y Apellido ===
      const filaNombre = crearFila();
      filaNombre.appendChild(crearBox(`<h2>${dataPersona.nombre} ${dataPersona.apellido || ""}</h2>`));
      contenedor.appendChild(filaNombre);

      // === Fila 2: Equipo (Entrando al documento) y Dorsal ===
      const filaInfo = crearFila();
      
      // Lógica para obtener el NOMBRE del equipo desde la referencia
      let nombreEquipoFinal = "Sin Equipo";
      if (dataPersona.equipo) {
        // Obtenemos el documento al que apunta la referencia
        const snapEquipo = await getDoc(dataPersona.equipo);
        if (snapEquipo.exists()) {
          nombreEquipoFinal = snapEquipo.data().nombre; // Sacamos el campo 'nombre'
        }
      }

      const equipoBox = crearBox(`<h2>${nombreEquipoFinal}</h2>`);
      equipoBox.classList.add("point");
      equipoBox.onclick = () => window.location.href = `equipo.html?team=${encodeURIComponent(nombreEquipoFinal)}`;
      
      const dorsalBox = crearBox(`<h2>#${dataPersona.dorsal || "-"}</h2>`);
      
      filaInfo.appendChild(equipoBox);
      filaInfo.appendChild(dorsalBox);
      contenedor.appendChild(filaInfo);

      // === Fila 3: Estadísticas Clave ===
      const filaStats = crearFila();

      const camposEbroBA = [
        { label: "JUGADOS", valor: 3 },
        { label: "SIN JUGAR", valor: 17 },
        { label: "TITULAR", valor: 2 },
        { label: "SUPLENTE", valor: 1 },
        { label: "GOLES", valor: 1 },
        { label: "POR PARTIDO", valor: 0.33 },
        { label: "AMARILLAS", valor: 0 },
        { label: "ROJAS", valor: 0 }
      ]

      const campos = [
        { label: "JUGADOS", valor: dataStats.PJ },
        { label: "SIN JUGAR", valor: dataStats.NJ },
        { label: "TITULAR", valor: dataStats.Tit },
        { label: "SUPLENTE", valor: dataStats.Sup },
        { label: dataStats.Goles >= 0 ? "GOLES" : "GOLES RECIB.", valor: dataStats.Goles > 0 ? dataStats.Goles : dataStats.Goles * (-1) },
        { label: "POR PARTIDO", valor: dataStats.Goles > 0 ? (dataStats.Goles / dataStats.PJ).toFixed(2) : ((dataStats.Goles * (-1)) / dataStats.PJ).toFixed(2) },
        { label: "AMARILLAS", valor: dataStats.Am },
        { label: "ROJAS", valor: dataStats.Roj }
      ];

      const camposEE = [
        { label: "JUGADOS", valor: dataStats.PJ },
        { label: "SIN JUGAR", valor: dataStats.NJ },
        { label: "TITULAR", valor: dataStats.Tit },
        { label: "SUPLENTE", valor: dataStats.Sup },
        { label: dataStats.Goles >= 0 ? "GOLES" : "GOLES RECIB.", valor: dataStats.Goles > 0 ? dataStats.Goles : dataStats.Goles * (-1) },
        { label: "POR PARTIDO", valor: dataStats.Goles > 0 ? ((dataStats.Goles - camposEbroBA[4].valor) / (dataStats.PJ - camposEbroBA[4].valor)).toFixed(2) : ((dataStats.Goles * (-1)) / dataStats.PJ).toFixed(2) },
        { label: "AMARILLAS", valor: dataStats.Am },
        { label: "ROJAS", valor: dataStats.Roj }
      ];

      if (idNumerico != 4) {
        campos.forEach(c => {
          const statDiv = document.createElement("div");
          statDiv.classList.add("stat-item");
          statDiv.innerHTML = `
            <strong style="text-decoration: underline; font-size: 15px;">${c.label}</strong>
            <br><br>
            <p style="font-size: 18px; font-style: italic;">${c.valor ?? "0"}</p>
          `;
          filaStats.appendChild(statDiv);
        });
        
        contenedor.appendChild(filaStats);
      } else {
        var indexE = 0;
        camposEE.forEach(c => {
          const statDiv = document.createElement("div");
          statDiv.classList.add("stat-item");
          statDiv.innerHTML = `
            <strong style="text-decoration: underline; font-size: 15px;">${c.label}</strong>
            <br><br>
            <p style="font-size: 18px; font-style: italic;">${c.label != "POR PARTIDO" ? c.valor - camposEbroBA[indexE].valor : c.valor}</p>
          `;
          filaStats.appendChild(statDiv);
          indexE++;
        });

        contenedor.appendChild(filaStats);

        const filaBA = crearFila();
        const equipoBox = crearBox(`<h2>Bilbao Athletic</h2>`);
        const dorsalBox = crearBox(`<h2>#5</h2>`);

        filaBA.appendChild(equipoBox);
        filaBA.appendChild(dorsalBox);
        contenedor.appendChild(filaBA);

        const filaStatBA = crearFila();
        
        camposEbroBA.forEach(c => {
          const statDiv = document.createElement("div");
          statDiv.classList.add("stat-item");
          statDiv.innerHTML = `
            <strong style="text-decoration: underline; font-size: 15px;">${c.label}</strong>
            <br><br>
            <p style="font-size: 18px; font-style: italic;">${c.valor ?? "0"}</p>
          `;
          filaStatBA.appendChild(statDiv);
        });

        contenedor.appendChild(filaStatBA);
      }

    } else {
      contenedor.innerHTML = `<p>Error: No se encontró el jugador en las colecciones.</p>`;
    }
  } catch (error) {
    console.error("Error al cargar Firebase:", error);
    contenedor.innerHTML = "<p>Error al conectar con la base de datos.</p>";
  }
}

// Funciones auxiliares
function crearFila() {
  const div = document.createElement("div");
  div.classList.add("fila");
  return div;
}

function crearBox(contenido) {
  const div = document.createElement("div");
  div.classList.add("info-box");
  div.innerHTML = contenido;
  return div;
}

window.addEventListener("DOMContentLoaded", cargarDetalle);
</script>
</body>
</html>