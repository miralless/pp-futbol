<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PP Football">
  <link rel="manifest" href="/db-futbol/manifest.json">
  <link rel="apple-touch-icon" href="icono.png">
  <title>Equipo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ... (Mantenemos tus estilos CSS intactos) ... */
    .team-container { width: 100%; margin: 30px auto; display: flex; flex-direction: column; gap: 20px; padding: 0 20px; flex: 1; justify-content: center; }
    .team-name { font-size: 1.8rem; text-align: center; color: white; background-color: #292929; padding: 25px; border-radius: 10px; font-weight: bold; }
    .titleInfo { font-size: 1rem; background-color: #444444; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .detailsDiv { display: flex; justify-content: space-around; gap: 10px; }
    .partido { display: flex; width: 100%; font-weight: bold; font-size: 1rem; background-color: #444444; color: white; padding: 15px; border-radius: 10px; align-items: center; justify-content: center; }
    .verde { color: #00ff88; }
    .nombreEquipo { font-size: 15px; text-align: center; }
  </style>
</head>
<body>
  <header class="navbar">
    <h1 class="logo">PP Football 2025/26</h1>
    <nav class="menu">
      <a href="index.html">Inicio</a>
      <a href="equipos.html">Equipos</a>
    </nav>
  </header>

  <div id="teamInfo" class="team-container"></div>

  <div style="display: flex; justify-content: center; margin: 20px 0; min-height: 100px;">
    <script async="async" data-cfasync="false" src="https://pl28653692.effectivegatecpm.com/db905bf48f3756afacdea982fc6d979d/invoke.js"></script>
    <div id="container-db905bf48f3756afacdea982fc6d979d"></div>
  </div>

  <footer class="footer">
    <p>© 2025 PP Football.<br>Todos los derechos reservados.</p>
    <div style="margin-top: 10px;">
      <a href="privacidad.html" style="color: #888; font-size: 0.8rem; margin: 0 10px;">Privacidad</a>
      <a href="cookies.html" style="color: #888; font-size: 0.8rem; margin: 0 10px;">Cookies</a>
    </div>
  </footer>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { firebaseConfig } from "./firebaseConfig.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const teamName = params.get("team");
  const teamContainer = document.getElementById("teamInfo");

  // 1. Mapeo para los IDs de los documentos de seguimiento (Scraping)
  const mapeoIdsSeguimiento = {
    "equipo_sd_eibar_b": "equipo_eibar_b",
    "equipo_indartsu_club": "equipo_indartsu",
    "equipo_cd_derio": "equipo_cd_derio",
    "equipo_fc_cartagena": "equipo_fc_cartagena"
  };

  // 2. Mapeo para los IDs de la colección "Equipos" (Base de datos principal)
  const mapeoIdsEquiposBase = {
    "SD Eibar B": "EQ01",
    "CD Derio": "EQ02",
    "Indartsu Club": "EQ03",
    "FC Cartagena": "EQ04"
    // Añade aquí el resto según los tengas en Firebase
  };

  const crearIdDocSeguimiento = (tipo, nombre) => {
      const idOriginal = `${tipo}_${nombre.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
      return mapeoIdsSeguimiento[idOriginal] || idOriginal;
  };

  function limpiarFecha(fechaSucio) {
    // 1. Extraer el mes (Jan) y el día (31) del final de la cadena
    const match = fechaSucio.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{1,2})/);
    // 2. Extraer el año (2026)
    const matchAnio = fechaSucio.match(/\d{4}/);

    if (match && matchAnio) {
        const meses = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08', 
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };

        const mes = meses[match[1]];
        const dia = match[2].padStart(2, '0');
        const anio = matchAnio[0];

        return `${dia}/${mes}/${anio}`;
    }
    return fechaSucio; // Si algo falla, devuelve el original
  }

  function formatearFechaSofa(fechaStr) {
      if (!fechaStr || typeof fechaStr !== 'string') return "---";

      // Separamos por la barra /
      const partes = fechaStr.split('/');

      // Validamos que tengamos las 3 partes (día, mes, año)
      if (partes.length !== 3) return fechaStr;

      // 1. Procesar Día y Mes: Añadimos cero a la izquierda si solo hay un dígito
      let dia = partes[0].padStart(2, '0');
      let mes = partes[1].padStart(2, '0');
      let anio = partes[2];

      // 2. Procesar Año: Si tiene 2 dígitos, asumimos que es el siglo XXI (20xx)
      if (anio.length === 2) {
          anio = '20' + anio;
      }

      return `${dia}/${mes}/${anio}`;
  }

  async function cargarEquipo() {
    if (!teamName) {
      teamContainer.innerHTML = "<p>No se especificó equipo.</p>";
      return;
    }

    // ID para seguimiento_futbol (ej: equipo_derio)
    const docStatsId = crearIdDocSeguimiento("equipo", teamName);
    const refStats = doc(db, "seguimiento_futbol", docStatsId);
    
    // ID para la colección Equipos (ej: EQ02)
    const idEquipoBase = mapeoIdsEquiposBase[teamName] || teamName;
    const refEquipoBase = doc(db, "Equipos", idEquipoBase);

    try {
      // Cargamos ambos documentos en paralelo
      const [snapStats, snapEquipoBase] = await Promise.all([
        getDoc(refStats),
        getDoc(refEquipoBase)
      ]);

      if (snapStats.exists()) {
        const dataStats = snapStats.data();
        
        // --- OBTENER NOMBRE REAL DE LA COLECCIÓN EQUIPOS ---
        let nombreOficial = teamName; 
        if (snapEquipoBase.exists()) {
          nombreOficial = snapEquipoBase.data().nombre; // Campo 'nombre' de la col Equipos
        }

        teamContainer.innerHTML = "";

        // --- 1. Título del Equipo ---
        const nameDiv = document.createElement("div");
        nameDiv.className = "team-name";
        nameDiv.textContent = nombreOficial;
        teamContainer.appendChild(nameDiv);

        const { ultimo, proximo } = dataStats;

        if (teamName != "Indartsu Club" && teamName != "FC Cartagena") {
          let jornada = 0;
          // --- 2. Bloque Último Partido ---
          if (ultimo) {
            const lastTitle = document.createElement("div");
            lastTitle.className = "titleInfo";

            const fecha = ultimo.fecha;
            const refClas = doc(db, "seguimiento_futbol", `clasificacion_${nombreClasif(teamName)}`);
            const snapClas = await getDoc(refClas);
            const data = snapClas.data();
            const tablaData = data.tabla;

            tablaData.forEach(element => {
              if (element.nombre == "C.D. Derio" || element.nombre == "S.D. Eibar B") {
                jornada = element.Jugados;
              }
            })

            lastTitle.innerHTML = `<h3>JORNADA ${jornada} (${formatearFechaSofa(fecha)})</h3>`;
            teamContainer.appendChild(lastTitle);

            const lastDetails = document.createElement("div");
            lastDetails.className = "detailsDiv";

            
            
            const esCasa = "Eibar B" == ultimo.local || "CD Derio" == ultimo.local;
            const rivalLimpio = esCasa ? ultimo.visitante : ultimo.local;

            lastDetails.innerHTML = `
                <div class="nombreEquipo partido ${esCasa ? 'verde' : ''}">${ultimo.local}</div>
                <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content; white-space: nowrap;">${ultimo.resultado}</div>
                <div class="nombreEquipo partido ${!esCasa ? 'verde' : ''}">${ultimo.visitante}</div>
            `;
            teamContainer.appendChild(lastDetails);
          }

          // --- 3. Bloque Próximo Partido ---

          const nextTitle = document.createElement("div");
          nextTitle.className = "titleInfo";

          let nombreNM = teamName == "SD Eibar B" ? "eibar_b" : "derio"

          const refClas = doc(db, "seguimiento_futbol", `lista_partidos_${nombreNM}`);
          const snapClas = await getDoc(refClas);
          const data = snapClas.data();
          const tablaData = data.partidos;

          const jornadaN = parseInt(jornada) + 1;
          
          const fecha = tablaData[0].fecha;
          const hora = tablaData[0].resultado_hora;

          nextTitle.innerHTML = `<h3>JORNADA ${jornadaN} (${formatearFechaSofa(fecha)})</h3>`;
          teamContainer.appendChild(nextTitle);

          const nextDetails = document.createElement("div");
          nextDetails.className = "detailsDiv";

          const esCasaProx = tablaData[0].equipo_1.includes("Eibar B") || tablaData[0].equipo_1.includes("CD Derio");

          nextDetails.innerHTML = `
              <div class="nombreEquipo partido ${esCasaProx ? 'verde' : ''}">${tablaData[0].equipo_1}</div>
              <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content;">${(parseInt(hora.split(":")[0]) + 1) + ":" + hora.split(":")[1]}</div>
              <div class="nombreEquipo partido ${!esCasaProx ? 'verde' : ''}">${tablaData[0].equipo_2}</div>
          `;
          teamContainer.appendChild(nextDetails);   

          cargaCalendario();

          function nombreClasif(nombre) {
            if (nombre == "CD Derio") return "cd_derio";
            if (nombre == "SD Eibar B") return "eibar_b";
          }

          try {
            const refClas = doc(db, "seguimiento_futbol", `clasificacion_${nombreClasif(teamName)}`);
            const snapClas = await getDoc(refClas);

            if (snapClas.exists()) {
              const data = snapClas.data();
              const tablaData = data.tabla;
              const nextTitle = document.createElement("div");
              nextTitle.className = "titleInfo";
              nextTitle.innerHTML = `<h3>CLASIFICACIÓN</h3><br><h5>${teamName == "CD Derio" ? "3ª RFEF (Gr. 4)" : "2ª RFEF (Gr. 2)"}</h5>`;
              teamContainer.appendChild(nextTitle);

              const containerClasificacion = document.createElement("div");
              containerClasificacion.style.padding = "10px";
              containerClasificacion.style.borderRadius = "10px";
              containerClasificacion.style.backgroundColor = "#444444";
              teamContainer.appendChild(containerClasificacion);

              const containerFila1 = document.createElement("div");
              // 1. Forzamos a que sea una fila horizontal que ocupe todo el ancho
              containerFila1.style.display = "flex";
              containerFila1.style.width = "100%";
              containerFila1.style.alignItems = "center";
              containerFila1.style.marginBottom = "10px";
              containerFila1.style.padding = "0";

              const posi = document.createElement("div");
              const nombre = document.createElement("div");
              const puntos = document.createElement("div");

              // posi.style.minWidth = "30px" // Ancho fijo para que todos los números queden alineados
              posi.style.fontWeight = "bold";
              posi.style.backgroundColor = "#292929"
              posi.style.borderRadius = "10px";
              posi.style.width = "18%";
              posi.style.height = "50px";
              posi.style.display = "flex";
              posi.style.alignItems = "center";   // Centrado vertical
              posi.style.justifyContent = "center"; // Centrado horizontal
              posi.innerHTML = `POS`;

              nombre.style.flexGrow = "1";
              nombre.style.textAlign = "left";
              nombre.style.backgroundColor = "#292929"
              nombre.style.borderRadius = "10px";
              nombre.style.marginLeft = "5px";
              nombre.style.paddingLeft = "15px";
              nombre.style.height = "50px";
              nombre.style.display = "flex";
              nombre.style.alignItems = "center";
              nombre.style.fontWeight = "bold";
              nombre.innerHTML = "EQUIPO";

              puntos.style.width = "18%";
              puntos.style.fontWeight = "bold";
              puntos.style.backgroundColor = "#292929"
              puntos.style.borderRadius = "10px";
              puntos.style.height = "50px";
              puntos.style.display = "flex";
              puntos.style.alignItems = "center";   // Centrado vertical
              puntos.style.justifyContent = "center"; // Centrado horizontal
              puntos.style.marginLeft = "5px";
              puntos.innerHTML = `PTS`;

              containerFila1.appendChild(posi);
              containerFila1.appendChild(nombre);
              containerFila1.appendChild(puntos);

              containerClasificacion.appendChild(containerFila1);

              let posicion = 1;

              tablaData.forEach(element => {
                const containerFila = document.createElement("div");
                // 1. Forzamos a que sea una fila horizontal que ocupe todo el ancho
                containerFila.style.display = "flex";
                containerFila.style.width = "100%";
                containerFila.style.alignItems = "center";
                containerFila.style.marginBottom = "10px";
                containerFila.style.padding = "0"; 
                // containerFila.style.backgroundColor = "#333333";
                
                // Opcional: añade tu clase para que tenga el fondo gris que usas en otros lados
                containerFila.className = "partido"; 

                const pos = document.createElement("div");
                // pos.style.minWidth = "fit-content"
                pos.style.fontWeight = "bold";
                pos.style.backgroundColor = "#333333"
                pos.style.borderRadius = "10px";
                pos.style.width = "18%";
                pos.style.height = "50px";
                pos.style.display = "flex";
                pos.style.alignItems = "center";   // Centrado vertical
                pos.style.justifyContent = "center"; // Centrado horizontal
                pos.innerHTML = `${posicion++}`;
                if (element.nombre == "S.D. Eibar B" || element.nombre == "C.D. Derio") {
                  pos.classList.add("verde");
                }
                if (teamName == "SD Eibar B") {
                  if (posicion > 14) {
                    pos.style.backgroundColor = "#552222";
                  } else if (posicion < 3) {
                    pos.style.backgroundColor = "#113311";
                  } else if (posicion < 7) {
                    pos.style.backgroundColor = "#448844";
                  } else if (posicion > 13) {
                    pos.style.backgroundColor = "#CCAA55";
                  }
                } else if (teamName == "CD Derio") {
                  if (posicion > 16) {
                    pos.style.backgroundColor = "#552222";
                  } else if (posicion < 3) {
                    pos.style.backgroundColor = "#113311";
                  } else if (posicion < 7) {
                    pos.style.backgroundColor = "#448844";
                  }
                }
                containerFila.appendChild(pos);

                const nombreEq = document.createElement("div");
                // 2. Usamos flex-grow para que el nombre ocupe el espacio restante
                nombreEq.style.flexGrow = "1";
                nombreEq.style.textAlign = "left";
                nombreEq.style.backgroundColor = "#333333"
                nombreEq.style.borderRadius = "10px";
                nombreEq.style.marginLeft = "5px";
                nombreEq.style.paddingLeft = "15px";
                nombreEq.style.height = "50px";
                nombreEq.style.display = "flex";
                nombreEq.style.alignItems = "center";   // Centrado vertical
                
                const nombreLimpio = element.nombre.replace(/"/g, '').replace(".", "").replace(".", "").replace(".", "").trim();
                nombreEq.innerHTML = nombreLimpio;
                if (element.nombre == "S.D. Eibar B" || element.nombre == "C.D. Derio") {
                  nombreEq.classList.add("verde");
                }
                containerFila.appendChild(nombreEq);

                const puntos = document.createElement("div");
                let pts = parseInt(element.Empatados) + parseInt((element.Ganados * 3));
                puntos.innerHTML = `${pts}`;
                puntos.style.width = "18%";
                puntos.style.fontWeight = "bold";
                puntos.style.backgroundColor = "#333333"
                puntos.style.borderRadius = "10px";
                puntos.style.height = "50px";
                puntos.style.display = "flex";
                puntos.style.alignItems = "center";   // Centrado vertical
                puntos.style.justifyContent = "center"; // Centrado horizontal
                puntos.style.marginLeft = "5px";
                if (element.nombre == "S.D. Eibar B" || element.nombre == "C.D. Derio") {
                  puntos.classList.add("verde");
                }

                if (teamName == "SD Eibar B") {
                    if (posicion > 14) {
                      puntos.style.backgroundColor = "#552222";
                    } else if (posicion < 3) {
                      puntos.style.backgroundColor = "#113311";
                    } else if (posicion < 7) {
                      puntos.style.backgroundColor = "#448844";
                    } else if (posicion > 13) {
                      puntos.style.backgroundColor = "#CCAA55";
                    }
                  } else if (teamName == "CD Derio") {
                    if (posicion > 16) {
                      puntos.style.backgroundColor = "#552222";
                    } else if (posicion < 3) {
                      puntos.style.backgroundColor = "#113311";
                    } else if (posicion < 7) {
                      puntos.style.backgroundColor = "#448844";
                    }
                  }

                if (teamName == "SD Eibar B") {
                    if (posicion > 14) {
                    nombreEq.style.backgroundColor = "#552222";
                  } else if (posicion < 3) {
                    nombreEq.style.backgroundColor = "#113311";
                  } else if (posicion < 7) {
                    nombreEq.style.backgroundColor = "#448844";
                  } else if (posicion > 13) {
                    nombreEq.style.backgroundColor = "#CCAA55";
                  }
                } else if (teamName == "CD Derio") {
                  if (posicion > 16) {
                    nombreEq.style.backgroundColor = "#552222";
                  } else if (posicion < 3) {
                    nombreEq.style.backgroundColor = "#113311";
                  } else if (posicion < 7) {
                    nombreEq.style.backgroundColor = "#448844";
                  }
                }

                containerFila.appendChild(puntos);

                containerFila.addEventListener("click", () => {
                  const pj = element.Jugados;
      
                  const pg = parseInt(element.Ganados);
                  const pe = parseInt(element.Empatados);
                  const pp = parseInt(element.Perdidos);

                  // Verificamos si ya estamos mostrando las estadísticas buscando un ID o clase específica
                  const yaExpandido = nombreEq.querySelector(".stats-container");

                  if (yaExpandido) {
                      // Si ya está expandido, volvemos al estado original
                      nombreEq.style.flexGrow = "1";
                      nombreEq.style.textAlign = "left";
                      nombreEq.style.backgroundColor = cargarColorPref(pos.innerText, teamName);
                      nombreEq.style.borderRadius = "10px";
                      nombreEq.style.marginLeft = "5px";
                      nombreEq.style.paddingLeft = "15px";
                      nombreEq.style.height = "50px";
                      nombreEq.style.display = "flex";
                      nombreEq.style.alignItems = "center"; 
                      nombreEq.style.flexDirection = "row";
                      
                      pos.style.height = "50px";
                      puntos.style.height = "50px";
                      nombreEq.innerHTML = element.nombre.replace(/"/g, '').replace(".", "").replace(".", "").replace(".", "").trim();
                  } else {
                      // Aumentamos la altura para que quepan las 3 líneas (Nombre + PJ + G/E/P)
                      nombreEq.style.height = "auto"; 
                      nombreEq.style.paddingTop = "10px";
                      nombreEq.style.paddingBottom = "10px";
                      nombreEq.style.paddingRight = "15px";

                      nombreEq.style.display = "flex";
                      nombreEq.style.flexDirection = "column";

                      nombreEq.innerHTML = `
                          <span style="font-size: 1rem; font-weight: bold; margin-bottom: 12px; color: ${element.nombre === "S.D. Eibar B" || element.nombre === "C.D. Derio" ? "#00ff88" : "white"}; width: 100%; text-align: left; text-decoration: underline;">
                              ${element.nombre.replace(/"/g, '').replace(".", "").replace(".", "").replace(".", "").trim()}
                          </span>

                          <div style="position: relative; width: 100%; padding: 15px 10px 10px 10px; border: 2px solid ${element.nombre === "S.D. Eibar B" || element.nombre === "C.D. Derio" ? "#00ff88" : "white"}; border-radius: 8px; margin-top: 5px;">
                              
                              <span style="position: absolute; top: -10px; left: 10px; background-color: ${cargarColorPref(pos.innerText, teamName)}; padding: 0 5px; font-size: 0.8rem; color: ${element.nombre === "S.D. Eibar B" || element.nombre === "C.D. Derio" ? "#00ff88" : "white"};">
                                  <strong>Jugados: </strong><i>${pj}</i>
                              </span>
                              
                              <div class="stats-container" style="display: flex; flex-direction: column; gap: 8px;">
                                  <div style="display: flex; width: 100%; font-size: 0.75rem; color: ${element.nombre === "S.D. Eibar B" || element.nombre === "C.D. Derio" ? "#00ff88" : "white"};">
                                      <span style="flex: 1;"><strong>G:</strong> <i>${pg}</i></span>
                                      <span style="flex: 1; text-align: center;"><strong>E:</strong> <i>${pe}</i></span>
                                      <span style="flex: 1; text-align: right;"><strong>P:</strong> <i>${pp}</i></span>
                                  </div>

                                  <div style="display: flex; width: 100%; font-size: 0.75rem; color: ${element.nombre === "S.D. Eibar B" || element.nombre === "C.D. Derio" ? "#00ff88" : "white"}; border-top: 2px solid ${element.nombre === "S.D. Eibar B" || element.nombre === "C.D. Derio" ? "#00ff88" : "white"}; pt: 5px; margin-top: 2px; padding-top: 5px;">
                                      <span style="flex: 1;"><strong>GF:</strong> <i>${element.GolesFavor}</i></span>
                                      <span style="flex: 1; text-align: right;"><strong>GC:</strong> <i>${element.GolesContra}</i></span>
                                  </div>
                              </div>
                          </div>
                      `;

                      pos.style.height = nombreEq.scrollHeight + "px";
                      puntos.style.height = nombreEq.scrollHeight + "px";
                  }
                });

                containerClasificacion.appendChild(containerFila);
            });
            }
          } catch (error) {
            // Salta el bloque de clasificación si hay error
          }

        } else if (teamName == "FC Cartagena") {
          let jornada = 0;
          // --- 2. Bloque Último Partido ---
          if (ultimo) {
            const lastTitle = document.createElement("div");
            lastTitle.className = "titleInfo";

            const fecha = ultimo.fecha;
            const refClas = doc(db, "seguimiento_futbol", `clasificacion_fc_cartagena`);
            const snapClas = await getDoc(refClas);
            const data = snapClas.data();
            const tablaData = data.tabla;

            tablaData.forEach(element => {
              if (element.nombre == "F.C. Cartagena") {
                jornada = element.Jugados;
              }
            })

            lastTitle.innerHTML = `<h3>JORNADA ${jornada} (${formatearFechaSofa(fecha)})</h3>`;
            teamContainer.appendChild(lastTitle);

            const lastDetails = document.createElement("div");
            lastDetails.className = "detailsDiv";
            
            const esCasa = ultimo.local.includes("Cartagena");
            const rivalLimpio = esCasa ? ultimo.visitante : ultimo.local;

            lastDetails.innerHTML = `
                <div class="nombreEquipo partido ${esCasa ? 'verde' : ''}">${ultimo.local}</div>
                <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content; white-space: nowrap;">${ultimo.resultado}</div>
                <div class="nombreEquipo partido ${!esCasa ? 'verde' : ''}">${ultimo.visitante}</div>
            `;
            teamContainer.appendChild(lastDetails);
          }

          // --- 3. Bloque Próximo Partido ---
          
          const nextTitle = document.createElement("div");
          nextTitle.className = "titleInfo";

          const refClas = doc(db, "seguimiento_futbol", `lista_partidos_cartagena`);
          const snapClas = await getDoc(refClas);
          const data = snapClas.data();
          const tablaData = data.partidos;

          const jornadaN = parseInt(jornada) + 1;
          
          const fecha = tablaData[0].fecha;
          const hora = tablaData[0].resultado_hora;

          nextTitle.innerHTML = `<h3>JORNADA ${jornadaN} (${formatearFechaSofa(fecha)})</h3>`;
          teamContainer.appendChild(nextTitle);

          const nextDetails = document.createElement("div");
          nextDetails.className = "detailsDiv";

          const esCasaProx = tablaData[0].equipo_1.includes("Cartagena");

          nextDetails.innerHTML = `
              <div class="nombreEquipo partido ${esCasaProx ? 'verde' : ''}">${tablaData[0].equipo_1}</div>
              <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content;">${(parseInt(hora.split(":")[0]) + 1) + ":" + hora.split(":")[1]}</div>
              <div class="nombreEquipo partido ${!esCasaProx ? 'verde' : ''}">${tablaData[0].equipo_2}</div>
          `;
          teamContainer.appendChild(nextDetails);

          cargaCalendario();
          
          try {
            const refClas = doc(db, "seguimiento_futbol", `clasificacion_fc_cartagena`);
            const snapClas = await getDoc(refClas);

            if (snapClas.exists()) {
              const data = snapClas.data();
              const tablaData = data.tabla;
              const nextTitle = document.createElement("div");
              nextTitle.className = "titleInfo";
              nextTitle.innerHTML = `<h3>CLASIFICACIÓN</h3><br><h5>1ª RFEF (Gr. 2)</h5>`;
              teamContainer.appendChild(nextTitle);

              const containerClasificacion = document.createElement("div");
              containerClasificacion.style.padding = "10px";
              containerClasificacion.style.borderRadius = "10px";
              containerClasificacion.style.backgroundColor = "#444444";
              teamContainer.appendChild(containerClasificacion);

              const containerFila1 = document.createElement("div");
              // 1. Forzamos a que sea una fila horizontal que ocupe todo el ancho
              containerFila1.style.display = "flex";
              containerFila1.style.width = "100%";
              containerFila1.style.alignItems = "center";
              containerFila1.style.marginBottom = "10px";
              containerFila1.style.padding = "0";

              const posi = document.createElement("div");
              const nombre = document.createElement("div");
              const puntos = document.createElement("div");

              // posi.style.minWidth = "30px" // Ancho fijo para que todos los números queden alineados
              posi.style.fontWeight = "bold";
              posi.style.backgroundColor = "#292929"
              posi.style.borderRadius = "10px";
              posi.style.width = "18%";
              posi.style.height = "50px";
              posi.style.display = "flex";
              posi.style.alignItems = "center";   // Centrado vertical
              posi.style.justifyContent = "center"; // Centrado horizontal
              posi.innerHTML = `POS`;

              nombre.style.flexGrow = "1";
              nombre.style.textAlign = "left";
              nombre.style.backgroundColor = "#292929"
              nombre.style.borderRadius = "10px";
              nombre.style.marginLeft = "5px";
              nombre.style.paddingLeft = "15px";
              nombre.style.height = "50px";
              nombre.style.display = "flex";
              nombre.style.alignItems = "center";
              nombre.style.fontWeight = "bold";
              nombre.innerHTML = "EQUIPO";

              puntos.style.width = "18%";
              puntos.style.fontWeight = "bold";
              puntos.style.backgroundColor = "#292929"
              puntos.style.borderRadius = "10px";
              puntos.style.height = "50px";
              puntos.style.display = "flex";
              puntos.style.alignItems = "center";   // Centrado vertical
              puntos.style.justifyContent = "center"; // Centrado horizontal
              puntos.style.marginLeft = "5px";
              puntos.innerHTML = `PTS`;

              containerFila1.appendChild(posi);
              containerFila1.appendChild(nombre);
              containerFila1.appendChild(puntos);

              containerClasificacion.appendChild(containerFila1);

              let posicion = 1;

              tablaData.forEach(element => {
                const containerFila = document.createElement("div");
                // 1. Forzamos a que sea una fila horizontal que ocupe todo el ancho
                containerFila.style.display = "flex";
                containerFila.style.width = "100%";
                containerFila.style.alignItems = "center";
                containerFila.style.marginBottom = "10px";
                containerFila.style.padding = "0"; 
                // containerFila.style.backgroundColor = "#333333";
                
                // Opcional: añade tu clase para que tenga el fondo gris que usas en otros lados
                containerFila.className = "partido"; 

                const pos = document.createElement("div");
                // pos.style.minWidth = "fit-content"
                pos.style.fontWeight = "bold";
                pos.style.backgroundColor = "#333333"
                pos.style.borderRadius = "10px";
                pos.style.width = "18%";
                pos.style.height = "50px";
                pos.style.display = "flex";
                pos.style.alignItems = "center";   // Centrado vertical
                pos.style.justifyContent = "center"; // Centrado horizontal
                pos.innerHTML = `${posicion++}`;
                if (element.nombre == "F.C. Cartagena") {
                  pos.classList.add("verde");
                }
                if (posicion > 16) {
                  pos.style.backgroundColor = "#552222";
                } else if (posicion < 3) {
                  pos.style.backgroundColor = "#113311";
                } else if (posicion < 7) {
                  pos.style.backgroundColor = "#448844";
                }
                containerFila.appendChild(pos);

                const nombreEq = document.createElement("div");
                // 2. Usamos flex-grow para que el nombre ocupe el espacio restante
                nombreEq.style.flexGrow = "1";
                nombreEq.style.textAlign = "left";
                nombreEq.style.backgroundColor = "#333333"
                nombreEq.style.borderRadius = "10px";
                nombreEq.style.marginLeft = "5px";
                nombreEq.style.paddingLeft = "15px";
                nombreEq.style.height = "50px";
                nombreEq.style.display = "flex";
                nombreEq.style.alignItems = "center";   // Centrado vertical
                
                const nombreLimpio = element.nombre.replace(/"/g, '').replace(".", "").replace(".", "").replace(".", "").replace(".", "").trim();
                nombreEq.innerHTML = nombreLimpio;
                if (element.nombre == "F.C. Cartagena") {
                  nombreEq.classList.add("verde");
                }
                containerFila.appendChild(nombreEq);

                const puntos = document.createElement("div");
                let pts = parseInt(element.Empatados) + parseInt((element.Ganados * 3));
                puntos.innerHTML = `${pts}`;
                puntos.style.width = "18%";
                puntos.style.fontWeight = "bold";
                puntos.style.backgroundColor = "#333333"
                puntos.style.borderRadius = "10px";
                puntos.style.height = "50px";
                puntos.style.display = "flex";
                puntos.style.alignItems = "center";   // Centrado vertical
                puntos.style.justifyContent = "center"; // Centrado horizontal
                puntos.style.marginLeft = "5px";
                if (element.nombre == "F.C. Cartagena") {
                  puntos.classList.add("verde");
                }
                if (posicion > 16) {
                  puntos.style.backgroundColor = "#552222";
                } else if (posicion < 3) {
                  puntos.style.backgroundColor = "#113311";
                } else if (posicion < 7) {
                  puntos.style.backgroundColor = "#448844";
                }

                if (posicion > 16) {
                  nombreEq.style.backgroundColor = "#552222";
                } else if (posicion < 3) {
                  nombreEq.style.backgroundColor = "#113311";
                } else if (posicion < 7) {
                  nombreEq.style.backgroundColor = "#448844";
                }

                containerFila.appendChild(puntos);

                containerFila.addEventListener("click", () => {
                  const pj = element.Jugados;
      
                  const pg = parseInt(element.Ganados);
                  const pe = parseInt(element.Empatados);
                  const pp = parseInt(element.Perdidos);

                  // Verificamos si ya estamos mostrando las estadísticas buscando un ID o clase específica
                  const yaExpandido = nombreEq.querySelector(".stats-container");

                  if (yaExpandido) {
                      // Si ya está expandido, volvemos al estado original
                      nombreEq.style.flexGrow = "1";
                      nombreEq.style.textAlign = "left";
                      nombreEq.style.backgroundColor = cargarColorCart(pos.innerText);
                      nombreEq.style.borderRadius = "10px";
                      nombreEq.style.marginLeft = "5px";
                      nombreEq.style.paddingLeft = "15px";
                      nombreEq.style.height = "50px";
                      nombreEq.style.display = "flex";
                      nombreEq.style.alignItems = "center"; 
                      nombreEq.style.flexDirection = "row";
                      
                      pos.style.height = "50px";
                      puntos.style.height = "50px";
                      nombreEq.innerHTML = element.nombre.replace(/"/g, '').replace(".", "").replace(".", "").replace(".", "").trim();
                  } else {
                      // Aumentamos la altura para que quepan las 3 líneas (Nombre + PJ + G/E/P)
                      nombreEq.style.height = "auto"; 
                      nombreEq.style.paddingTop = "10px";
                      nombreEq.style.paddingBottom = "10px";
                      nombreEq.style.paddingRight = "15px";

                      nombreEq.style.display = "flex";
                      nombreEq.style.flexDirection = "column";

                      nombreEq.innerHTML = `
                          <span style="font-size: 1rem; font-weight: bold; margin-bottom: 12px; color: ${element.nombre === "F.C. Cartagena" ? "#00ff88" : "white"}; width: 100%; text-align: left; text-decoration: underline;">
                              ${element.nombre.replace(/"/g, '').replace(".", "").replace(".", "").replace(".", "").trim()}
                          </span>

                          <div style="position: relative; width: 100%; padding: 15px 10px 10px 10px; border: 2px solid ${element.nombre === "F.C. Cartagena" ? "#00ff88" : "white"}; border-radius: 8px; margin-top: 5px;">
                              
                              <span style="position: absolute; top: -10px; left: 10px; background-color: ${cargarColorCart(pos.innerText)}; padding: 0 5px; font-size: 0.8rem; color: ${element.nombre === "F.C. Cartagena" ? "#00ff88" : "white"};">
                                  <strong>Jugados: </strong><i>${pj}</i>
                              </span>
                              
                              <div class="stats-container" style="display: flex; flex-direction: column; gap: 8px;">
                                  <div style="display: flex; width: 100%; font-size: 0.75rem; color: ${element.nombre === "F.C. Cartagena" ? "#00ff88" : "white"};">
                                      <span style="flex: 1;"><strong>G:</strong> <i>${pg}</i></span>
                                      <span style="flex: 1; text-align: center;"><strong>E:</strong> <i>${pe}</i></span>
                                      <span style="flex: 1; text-align: right;"><strong>P:</strong> <i>${pp}</i></span>
                                  </div>

                                  <div style="display: flex; width: 100%; font-size: 0.75rem; color: ${element.nombre === "F.C. Cartagena" ? "#00ff88" : "white"}; border-top: 2px solid ${element.nombre === "F.C. Cartagena" ? "#00ff88" : "white"}; pt: 5px; margin-top: 2px; padding-top: 5px;">
                                      <span style="flex: 1;"><strong>GF:</strong> <i>${element.GolesFavor}</i></span>
                                      <span style="flex: 1; text-align: right;"><strong>GC:</strong> <i>${element.GolesContra}</i></span>
                                  </div>
                              </div>
                          </div>
                      `;

                      pos.style.height = nombreEq.scrollHeight + "px";
                      puntos.style.height = nombreEq.scrollHeight + "px";
                  }
                });

                containerClasificacion.appendChild(containerFila);
            });
            }
          } catch (error) {
            // Salta el bloque de clasificación si hay error
          }


        } else {
          // --- 2. Bloque Último Partido ---
        if (ultimo) {
          const lastTitle = document.createElement("div");
          lastTitle.className = "titleInfo";

          var jornadaLimpia = ultimo.infoJornada.split(' ')[0] + " " + ultimo.infoJornada.split(' ')[1]

          /* var fecha = ultimo.infoJornada.split(' ')[0].replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
              const dia = d.padStart(2, '0');
              const mes = m.padStart(2, '0');
              return `${dia}/${mes}/${y}`;
          }); */

          var hora = ultimo.infoJornada.split(' ')[3];

          lastTitle.innerHTML = `<h3>${jornadaLimpia} ${ultimo.infoJornada.split(" ")[2]}</h3>`;
          teamContainer.appendChild(lastTitle);

          const lastDetails = document.createElement("div");
          lastDetails.className = "detailsDiv";
          
          const esCasa = ultimo.rival.includes("(C)");
          const rivalLimpio = ultimo.rival.replace("(C)", "").replace("(F)", "").trim();

          ultimo.resultado = ultimo.resultado.replace("P", "");
          ultimo.resultado = ultimo.resultado.replace("G", "");
          ultimo.resultado = ultimo.resultado.replace("E", "");

          const rival = rivalLimpio.replace('"', "").replace('"', '').trim();

          lastDetails.innerHTML = `
              <div class="nombreEquipo partido ${esCasa ? 'verde' : ''}">${esCasa ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rival)}</div>
              <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content; white-space: nowrap;">${ultimo.resultado}</div>
              <div class="nombreEquipo partido ${!esCasa ? 'verde' : ''}">${!esCasa ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rival)}</div>
          `;
          teamContainer.appendChild(lastDetails);
        }

        // --- 3. Bloque Próximo Partido ---
        if (proximo) {
          const nextTitle = document.createElement("div");
          nextTitle.className = "titleInfo";

          var jornadaLimpia = proximo.infoJornada.split(' ')[0] + " " + proximo.infoJornada.split(' ')[1]

          var fecha = proximo.resultado.split(' ')[0].replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
              const dia = d.padStart(2, '0');
              const mes = m.padStart(2, '0');
              return `${dia}/${mes}/${y}`;
          });

          var hora = proximo.resultado.split(' ')[1];

          nextTitle.innerHTML = `<h3>${jornadaLimpia} (${fecha})</h3>`;
          teamContainer.appendChild(nextTitle);

          const nextDetails = document.createElement("div");
          nextDetails.className = "detailsDiv";

          const esCasaProx = proximo.rival.includes("(C)");
          const rivalProxLimpio = proximo.rival.replace("(C)", "").replace("(F)", "").trim();

          const rivalProx = rivalProxLimpio.replace('"', "").replace('"', '').trim();

          nextDetails.innerHTML = `
              <div class="nombreEquipo partido ${esCasaProx ? 'verde' : ''}">${esCasaProx ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rivalProx)}</div>
              <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content;">${hora}</div>
              <div class="nombreEquipo partido ${!esCasaProx ? 'verde' : ''}">${!esCasaProx ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rivalProx)}</div>
          `;
          teamContainer.appendChild(nextDetails);
        }

        cargaCalendario();

        try {
          const refClas = doc(db, "seguimiento_futbol", "clasificacion_indartsu");
          const snapClas = await getDoc(refClas);

          if (snapClas.exists()) {
            const data = snapClas.data();
            const tablaData = data.tabla;
            const nextTitle = document.createElement("div");
            nextTitle.className = "titleInfo";
            nextTitle.innerHTML = `<h3>CLASIFICACIÓN</h3><br><h5>1ª REG (Gr. 2)</h5>`;
            teamContainer.appendChild(nextTitle);

            const containerClasificacion = document.createElement("div");
            containerClasificacion.style.padding = "10px";
            containerClasificacion.style.borderRadius = "10px";
            containerClasificacion.style.backgroundColor = "#444444";
            teamContainer.appendChild(containerClasificacion);

            const containerFila1 = document.createElement("div");
            // 1. Forzamos a que sea una fila horizontal que ocupe todo el ancho
            containerFila1.style.display = "flex";
            containerFila1.style.width = "100%";
            containerFila1.style.alignItems = "center";
            containerFila1.style.marginBottom = "10px";
            containerFila1.style.padding = "0";

            const posi = document.createElement("div");
            const nombre = document.createElement("div");
            const puntos = document.createElement("div");

            // posi.style.minWidth = "30px" // Ancho fijo para que todos los números queden alineados
            posi.style.fontWeight = "bold";
            posi.style.backgroundColor = "#292929"
            posi.style.borderRadius = "10px";
            posi.style.width = "18%";
            posi.style.height = "50px";
            posi.style.display = "flex";
            posi.style.alignItems = "center";   // Centrado vertical
            posi.style.justifyContent = "center"; // Centrado horizontal
            posi.innerHTML = `POS`;

            nombre.style.flexGrow = "1";
            nombre.style.textAlign = "left";
            nombre.style.backgroundColor = "#292929"
            nombre.style.borderRadius = "10px";
            nombre.style.marginLeft = "5px";
            nombre.style.paddingLeft = "15px";
            nombre.style.height = "50px";
            nombre.style.display = "flex";
            nombre.style.alignItems = "center";
            nombre.style.fontWeight = "bold";
            nombre.innerHTML = "EQUIPO";

            puntos.style.width = "18%";
            puntos.style.fontWeight = "bold";
            puntos.style.backgroundColor = "#292929"
            puntos.style.borderRadius = "10px";
            puntos.style.height = "50px";
            puntos.style.display = "flex";
            puntos.style.alignItems = "center";   // Centrado vertical
            puntos.style.justifyContent = "center"; // Centrado horizontal
            puntos.style.marginLeft = "5px";
            puntos.innerHTML = `PTS`;

            containerFila1.appendChild(posi);
            containerFila1.appendChild(nombre);
            containerFila1.appendChild(puntos);

            containerClasificacion.appendChild(containerFila1);

            let posicion = 1;

            tablaData.forEach(element => {
              const containerFila = document.createElement("div");
              // 1. Forzamos a que sea una fila horizontal que ocupe todo el ancho
              containerFila.style.display = "flex";
              containerFila.style.width = "100%";
              containerFila.style.alignItems = "center";
              containerFila.style.marginBottom = "10px";
              containerFila.style.padding = "0"; 
              // containerFila.style.backgroundColor = "#333333";
              
              // Opcional: añade tu clase para que tenga el fondo gris que usas en otros lados
              containerFila.className = "partido"; 

              const pos = document.createElement("div");
              // pos.style.minWidth = "fit-content"
              pos.style.fontWeight = "bold";
              pos.style.backgroundColor = "#333333"
              pos.style.borderRadius = "10px";
              pos.style.width = "18%";
              pos.style.height = "50px";
              pos.style.display = "flex";
              pos.style.alignItems = "center";   // Centrado vertical
              pos.style.justifyContent = "center"; // Centrado horizontal
              pos.innerHTML = `${posicion++}`;
              if (element.nombre == "INDARTSU") {
                pos.classList.add("verde");
              }
              if (posicion > 17) {
                pos.style.backgroundColor = "#552222";
              } else if (posicion < 4) {
                pos.style.backgroundColor = "#113311";
              }
              containerFila.appendChild(pos);

              const nombreEq = document.createElement("div");
              // 2. Usamos flex-grow para que el nombre ocupe el espacio restante
              nombreEq.style.flexGrow = "1";
              nombreEq.style.textAlign = "left";
              nombreEq.style.backgroundColor = "#333333"
              nombreEq.style.borderRadius = "10px";
              nombreEq.style.marginLeft = "5px";
              nombreEq.style.paddingLeft = "15px";
              nombreEq.style.height = "50px";
              nombreEq.style.display = "flex";
              nombreEq.style.alignItems = "center";   // Centrado vertical
              
              const nombreLimpio = element.nombre.replace(/"/g, '').trim();
              nombreEq.innerHTML = formatearNombreEquipo(nombreLimpio);
              if (element.nombre == "INDARTSU") {
                nombreEq.classList.add("verde");
                nombreEq.innerHTML = "Indartsu Club";
              } else if (element.nombre == "LEMOAHARROBI") {
                nombreEq.innerHTML = "Lemoa Harrobi";
              }
              if (posicion > 17) {
                nombreEq.style.backgroundColor = "#552222";
              } else if (posicion < 4) {
                nombreEq.style.backgroundColor = "#113311";
              }
              containerFila.appendChild(nombreEq);

              const puntos = document.createElement("div");
              let pts = parseInt(element.EmpatadosCasa) + parseInt(element.EmpatadosFuera) + parseInt((element.GanadosCasa * 3)) + parseInt((element.GanadosFuera * 3));
              puntos.innerHTML = `${pts}`;
              puntos.style.width = "18%";
              puntos.style.fontWeight = "bold";
              puntos.style.backgroundColor = "#333333"
              puntos.style.borderRadius = "10px";
              puntos.style.height = "50px";
              puntos.style.display = "flex";
              puntos.style.alignItems = "center";   // Centrado vertical
              puntos.style.justifyContent = "center"; // Centrado horizontal
              puntos.style.marginLeft = "5px";
              if (element.nombre == "INDARTSU") {
                puntos.classList.add("verde");
              }
              if (posicion > 17) {
                puntos.style.backgroundColor = "#552222";
              } else if (posicion < 4) {
                puntos.style.backgroundColor = "#113311";
              }
              containerFila.appendChild(puntos);

              containerFila.addEventListener("click", () => {
                const pj = parseInt(element.GanadosCasa) + parseInt(element.GanadosFuera) + 
                parseInt(element.EmpatadosCasa) + parseInt(element.EmpatadosFuera) + 
                parseInt(element.PerdidosCasa) + parseInt(element.PerdidosFuera);
    
                const pg = parseInt(element.GanadosCasa) + parseInt(element.GanadosFuera);
                const pe = parseInt(element.EmpatadosCasa) + parseInt(element.EmpatadosFuera);
                const pp = parseInt(element.PerdidosCasa) + parseInt(element.PerdidosFuera);

                // Verificamos si ya estamos mostrando las estadísticas buscando un ID o clase específica
                const yaExpandido = nombreEq.querySelector(".stats-container");

                if (yaExpandido) {
                    // Si ya está expandido, volvemos al estado original
                    nombreEq.style.flexGrow = "1";
                    nombreEq.style.textAlign = "left";
                    nombreEq.style.backgroundColor = cargarColor(pos.innerText);
                    nombreEq.style.borderRadius = "10px";
                    nombreEq.style.marginLeft = "5px";
                    nombreEq.style.paddingLeft = "15px";
                    nombreEq.style.height = "50px";
                    nombreEq.style.display = "flex";
                    nombreEq.style.alignItems = "center"; 
                    nombreEq.style.flexDirection = "row";
                    
                    pos.style.height = "50px";
                    puntos.style.height = "50px";
                    nombreEq.innerHTML = element.nombre === "INDARTSU" ? "Indartsu Club" : formatearNombreEquipo(nombreLimpio);
                } else {
                    // Aumentamos la altura para que quepan las 3 líneas (Nombre + PJ + G/E/P)
                    nombreEq.style.height = "auto"; 
                    nombreEq.style.paddingTop = "10px";
                    nombreEq.style.paddingBottom = "10px";
                    nombreEq.style.paddingRight = "15px";

                    nombreEq.style.display = "flex";
                    nombreEq.style.flexDirection = "column";

                    nombreEq.innerHTML = `
                        <span style="font-size: 1rem; font-weight: bold; margin-bottom: 12px; color: ${element.nombre === "INDARTSU" ? "#00ff88" : "white"}; width: 100%; text-align: left; text-decoration: underline;">
                            ${element.nombre === "INDARTSU" ? "Indartsu Club" : formatearNombreEquipo(nombreLimpio)}
                        </span>

                        <div style="position: relative; width: 100%; padding: 15px 10px 10px 10px; border: 2px solid ${element.nombre === "INDARTSU" ? "#00ff88" : "white"}; border-radius: 8px; margin-top: 5px;">
                            
                            <span style="position: absolute; top: -10px; left: 10px; background-color: ${cargarColor(pos.innerText)}; padding: 0 5px; font-size: 0.8rem; color: ${element.nombre === "INDARTSU" ? "#00ff88" : "white"};">
                                <strong>Jugados: </strong><i>${pj}</i>
                            </span>
                            
                            <div class="stats-container" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; width: 100%; font-size: 0.75rem; color: ${element.nombre === "INDARTSU" ? "#00ff88" : "white"};">
                                    <span style="flex: 1;"><strong>G:</strong> <i>${pg}</i></span>
                                    <span style="flex: 1; text-align: center;"><strong>E:</strong> <i>${pe}</i></span>
                                    <span style="flex: 1; text-align: right;"><strong>P:</strong> <i>${pp}</i></span>
                                </div>

                                <div style="display: flex; width: 100%; font-size: 0.75rem; color: ${element.nombre === "INDARTSU" ? "#00ff88" : "white"}; border-top: 2px solid ${element.nombre === "INDARTSU" ? "#00ff88" : "white"}; pt: 5px; margin-top: 2px; padding-top: 5px;">
                                    <span style="flex: 1;"><strong>GF:</strong> <i>${element.GolesFavor}</i></span>
                                    <span style="flex: 1; text-align: right;"><strong>GC:</strong> <i>${element.GolesContra}</i></span>
                                </div>
                            </div>
                        </div>
                    `;

                    pos.style.height = nombreEq.scrollHeight + "px";
                    puntos.style.height = nombreEq.scrollHeight + "px";
                }
              });

              containerClasificacion.appendChild(containerFila);
          });
          }
        } catch (error) {
          // Salta el bloque de clasificación si hay error
        }
      }

      const nextTitle = document.createElement("div");
      nextTitle.style.display = "flex";

      const mediaQuery = window.matchMedia("(min-width: 600px)");

      const containerAscensoDirecto = document.createElement("div");
      containerAscensoDirecto.style.width = "auto";
      containerAscensoDirecto.style.marginRight = "15px";
      containerAscensoDirecto.style.marginBottom = "8px";

      const containerAscensoPlayOff = document.createElement("div");
      containerAscensoPlayOff.style.width = "auto";
      containerAscensoPlayOff.style.marginRight = "15px";
      const containerDescensoPlayOff = document.createElement("div");
      containerDescensoPlayOff.style.width = "auto";
      containerDescensoPlayOff.style.marginRight = "15px";
      const containerDescenso = document.createElement("div");
      containerDescenso.style.width = "auto";

      // 1. Configurar el contenedor como Flexbox
      containerAscensoDirecto.style.display = "flex";
      containerAscensoDirecto.style.alignItems = "center"; // Centra verticalmente el cuadradito con el texto
      containerAscensoDirecto.style.gap = "8px"; // Añade una separación entre el cuadro y el texto

      // 2. El cuadrado de color
      const divAscensoDirecto = document.createElement("div");
      divAscensoDirecto.style.backgroundColor = "#113311";
      divAscensoDirecto.style.width = "18px";
      divAscensoDirecto.style.height = "18px";
      divAscensoDirecto.style.borderRadius = "5px";
      // Evitar que el flex lo encoja si el texto es muy largo
      divAscensoDirecto.style.flexShrink = "0"; 

      containerAscensoDirecto.appendChild(divAscensoDirecto);

      // 3. El texto
      const p = document.createElement("p");
      p.innerText = "Ascenso";
      // Quitamos los márgenes por defecto del <p> para que no rompa la alineación
      p.style.margin = "0";
      p.style.fontWeight = "bold"; 
      p.style.fontSize = "12px";

      containerAscensoDirecto.appendChild(p);

      // 4. Añadir al título
      nextTitle.appendChild(containerAscensoDirecto);

      // --- Bloque Ascenso PlayOff ---
      containerAscensoPlayOff.style.display = "flex";
      containerAscensoPlayOff.style.alignItems = "center";
      containerAscensoPlayOff.style.gap = "8px";
      containerAscensoPlayOff.style.marginBottom = "8px";
      containerAscensoPlayOff.style.justifyContent = "flex-end";

      const divAscensoPlayOff = document.createElement("div");
      divAscensoPlayOff.style.backgroundColor = "#448844";
      divAscensoPlayOff.style.width = "18px";
      divAscensoPlayOff.style.height = "18px";
      divAscensoPlayOff.style.borderRadius = "5px";
      divAscensoPlayOff.style.flexShrink = "0";

      const pPlayOff = document.createElement("p");
      pPlayOff.innerText = "PlayOff de Ascenso";
      pPlayOff.style.margin = "0";
      pPlayOff.style.fontWeight = "bold"; 
      pPlayOff.style.fontSize = "12px";

      containerAscensoPlayOff.appendChild(divAscensoPlayOff);
      containerAscensoPlayOff.appendChild(pPlayOff);
      nextTitle.appendChild(containerAscensoPlayOff);


      // --- Bloque Descenso PlayOff ---
      containerDescensoPlayOff.style.display = "flex";
      containerDescensoPlayOff.style.alignItems = "center";
      containerDescensoPlayOff.style.gap = "8px";
      containerDescensoPlayOff.style.marginBottom = "8px";

      const divDescensoPlayOff = document.createElement("div");
      divDescensoPlayOff.style.backgroundColor = "#CCAA55";
      divDescensoPlayOff.style.width = "18px";
      divDescensoPlayOff.style.height = "18px";
      divDescensoPlayOff.style.borderRadius = "5px";
      divDescensoPlayOff.style.flexShrink = "0";

      const pDescensoPO = document.createElement("p");
      pDescensoPO.innerText = "PlayOff de Descenso";
      pDescensoPO.style.margin = "0";
      pDescensoPO.style.fontWeight = "bold"; 
      pDescensoPO.style.fontSize = "12px";

      containerDescensoPlayOff.appendChild(divDescensoPlayOff);
      containerDescensoPlayOff.appendChild(pDescensoPO);
      nextTitle.appendChild(containerDescensoPlayOff);


      // --- Bloque Descenso Directo ---
      containerDescenso.style.display = "flex";
      containerDescenso.style.alignItems = "center";
      containerDescenso.style.gap = "8px";
      containerDescenso.style.marginBottom = "8px";
      containerDescenso.style.justifyContent = "flex-end";

      const divDescenso = document.createElement("div");
      divDescenso.style.backgroundColor = "#552222";
      divDescenso.style.width = "18px";
      divDescenso.style.height = "18px";
      divDescenso.style.borderRadius = "5px";
      divDescenso.style.flexShrink = "0";

      const pDescenso = document.createElement("p");
      pDescenso.innerText = "Descenso";
      pDescenso.style.margin = "0";
      pDescenso.style.fontWeight = "bold"; 
      pDescenso.style.fontSize = "12px";

      
      containerDescenso.appendChild(divDescenso);
      containerDescenso.appendChild(pDescenso);
      nextTitle.appendChild(containerDescenso);

      teamContainer.appendChild(nextTitle);

      function handleTabletChange(e) {
        // 1. Forzamos el contenedor padre a ocupar todo el ancho y permitir saltos de línea
        nextTitle.style.display = "flex";
        nextTitle.style.flexWrap = "wrap"; 
        nextTitle.style.width = "100%"; // Crucial para que el wrap funcione

        if (e.matches) {
            // PANTALLA ANCHA: Todo en una fila
            nextTitle.style.flexDirection = "row";

            containerAscensoPlayOff.removeChild(pPlayOff);
            containerDescenso.removeChild(pDescenso);

            containerAscensoPlayOff.appendChild(pPlayOff);
            containerDescenso.appendChild(pDescenso);
            
            [containerAscensoDirecto, containerAscensoPlayOff, containerDescensoPlayOff, containerDescenso].forEach(c => {
                if(c) {
                    c.style.flex = "0 1 auto"; 
                    c.style.width = "auto";
                    c.style.marginRight = "15px";
                }
            });
        } else {
            // MÓVIL: 2 por fila (Rejilla 2x2)
            nextTitle.style.flexDirection = "row";

            containerAscensoPlayOff.removeChild(divAscensoPlayOff);
            containerDescenso.removeChild(divDescenso);

            containerAscensoPlayOff.appendChild(divAscensoPlayOff);
            containerDescenso.appendChild(divDescenso);
            
            [containerAscensoDirecto, containerAscensoPlayOff, containerDescensoPlayOff, containerDescenso].forEach(c => {
                if(c) {
                    // Forzamos el 50% exacto usando border-box
                    c.style.boxSizing = "border-box";
                    c.style.flex = "0 0 50%"; 
                    c.style.width = "50%";
                    
                    // Quitamos el margin derecho que pusiste arriba para que no sume ancho extra
                    c.style.marginRight = "0px";
                    c.style.paddingRight = "5px"; // Usamos padding para separar sin romper el 50%
                }
            });
        }
      }

      // Escuchar cambios de tamaño
      mediaQuery.addListener(handleTabletChange);

      // Ejecutar al inicio
      handleTabletChange(mediaQuery);

      } else {
        teamContainer.innerHTML = `<p>No se encontraron estadísticas para este equipo.</p>`;
      }
    } catch (error) {
      console.error("Error Firebase:", error);
      teamContainer.innerHTML = "<p>Error al conectar con la base de datos.</p>";
    }
  }

  async function cargaCalendario() {
    const nombreParaCalendario = teamName == "FC Cartagena" ? "cartagena" : teamName == "SD Eibar B" ? "eibar_b" : teamName == "CD Derio" ? "derio" : "indartsu";

    try {
        const refClas = doc(db, "seguimiento_futbol", `lista_partidos_${nombreParaCalendario}`);
        const snapClas = await getDoc(refClas);

        if (snapClas.exists()) {
            const todosLosPartidos = snapClas.data().partidos || [];
            const HOY = new Date();
            let fechaActual = new Date();

            const schedule = document.createElement("div");
            schedule.className = "titleInfo";
            schedule.innerHTML = `<h3>CALENDARIO</h3>`;
            teamContainer.appendChild(schedule);

            const containerCalendario = document.createElement("div");
            containerCalendario.style.padding = "10px";
            containerCalendario.style.borderRadius = "10px";
            containerCalendario.style.backgroundColor = "#444444";
            containerCalendario.style.color = "white";
            containerCalendario.style.fontFamily = "sans-serif";
            teamContainer.appendChild(containerCalendario);

            function renderizarCalendario() {
                containerCalendario.innerHTML = "";

                const anio = fechaActual.getFullYear();
                const mes = fechaActual.getMonth();
                const nombreMes = new Intl.DateTimeFormat('es-ES', { month: 'long' }).format(fechaActual);
                const esMesActual = (anio === HOY.getFullYear() && mes === HOY.getMonth());

                const header = document.createElement("div");
                header.style.display = "flex";
                header.style.justifyContent = "space-between";
                header.style.alignItems = "center";
                header.style.marginBottom = "15px";
                header.innerHTML = `
                    <button id="prevMes" style="background-color: #333333; border:1px solid #333333; color:white; cursor:pointer; padding:5px 10px; border-radius:5px; visibility: ${esMesActual ? 'hidden' : 'visible'};">&lt;</button>
                    <span style="text-transform: capitalize; font-weight: bold;">${nombreMes} ${anio}</span>
                    <button id="nextMes" style="background-color: #333333; border:1px solid #333333; color:white; cursor:pointer; padding:5px 10px; border-radius:5px;">&gt;</button>
                `;
                containerCalendario.appendChild(header);

                const grid = document.createElement("div");
                grid.style.display = "grid";
                grid.style.gridTemplateColumns = "0.6fr 0.6fr 0.6fr 0.6fr 0.6fr 1.3fr 1.3fr";
                grid.style.gap = "3px";

                const diasSemana = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
                diasSemana.forEach(dia => {
                    const d = document.createElement("div");
                    d.style.textAlign = "center";
                    d.style.marginBottom = "8px";
                    d.style.fontWeight = "bold";
                    d.style.fontSize = "0.7em";
                    d.style.color = "#aaa";
                    d.innerText = dia;
                    grid.appendChild(d);
                });

                const primerDiaMes = new Date(anio, mes, 1);
                const ultimoDiaMes = new Date(anio, mes + 1, 0).getDate();
                const startColumn = primerDiaMes.getDay() === 0 ? 7 : primerDiaMes.getDay();

                for (let dia = 1; dia <= ultimoDiaMes; dia++) {
                    const fechaIter = new Date(anio, mes, dia);
                    const dSemana = fechaIter.getDay();

                    let elemento = document.createElement("div");

                    if (dia === 1 && dSemana === 0) {
                      elemento.style.backgroundColor = "#333333";
                      elemento.style.borderRadius = "4px";
                      elemento.style.display = "flex";
                      elemento.style.justifyContent = "center";
                      elemento.style.alignItems = "center";
                      elemento.style.position = "relative";
                      elemento.style.minHeight = "40px";
                      elemento.style.aspectRatio = "1.6 / 1"
                      elemento.style.gridColumn = "7 / span 1"; // Última columna del grid

                      const esHoyDom = (dia === HOY.getDate() && mes === HOY.getMonth() && anio === HOY.getFullYear());
                      if (esHoyDom) elemento.style.backgroundColor = "#ff4444";

                      // Número Domingo (Superior Derecha)
                      const numDom = document.createElement("span");
                      numDom.innerText = dia;
                      numDom.style.cssText = `position:absolute; top:2px; right:4px; font-size:0.55em; color:${esHoyDom ? '#fff' : '#aaa'};`;
                      elemento.appendChild(numDom);
                      
                      // Aquí podrías añadir la lógica de búsqueda de partido para este domingo solitario si quisieras
                      
                      grid.appendChild(elemento);
                      continue; // Saltamos a la siguiente iteración (día 2)
                    }

                    if (dSemana === 6 || (dSemana === 0 && dia !== 1)) {
                        if (dSemana === 6) {
                            elemento.style.backgroundColor = "#333333";
                            elemento.style.borderRadius = "4px";
                            elemento.style.display = "flex";
                            elemento.style.flexDirection = "column";
                            elemento.style.justifyContent = "center";
                            elemento.style.alignItems = "center";
                            elemento.style.padding = "5px";
                            elemento.style.minHeight = "45px";
                            elemento.style.position = "relative";
                            elemento.style.gridColumn = (dia === 1) ? "6 / span 2" : "span 2";

                            const esHoySabado = (dia === HOY.getDate() && mes === HOY.getMonth() && anio === HOY.getFullYear());
                            const esHoyDomingo = (dia + 1 === HOY.getDate() && mes === HOY.getMonth() && anio === HOY.getFullYear());

                            if (esHoySabado || esHoyDomingo) {
                                elemento.style.backgroundColor = "#ff4444";
                                elemento.style.fontWeight = "bold";
                            }

                            // Número Sábado (Superior Izquierda)
                            const numSab = document.createElement("span");
                            numSab.innerText = dia;
                            numSab.style.cssText = `position:absolute; top:2px; left:4px; font-size:0.55em; color:${esHoySabado || esHoyDomingo ? '#fff' : '#aaa'};`;
                            elemento.appendChild(numSab);

                            // Número Domingo (Superior Derecha)
                            if (dia + 1 <= ultimoDiaMes) {
                                const numDom = document.createElement("span");
                                numDom.innerText = dia + 1;
                                numDom.style.cssText = `position:absolute; top:2px; right:4px; font-size:0.55em; color:${esHoySabado || esHoyDomingo ? '#fff' : '#aaa'};`;
                                elemento.appendChild(numDom);
                            }

                            // Generar fechas de Sábado y Domingo para buscar el partido
                            const fechaLun = new Date(anio, mes, dia - 5);
                            const fechaMar = new Date(anio, mes, dia - 4);
                            const fechaMie = new Date(anio, mes, dia - 3);
                            const fechaJue = new Date(anio, mes, dia - 2);
                            const fechaVie = new Date(anio, mes, dia - 1);
                            const fechaSab = new Date(anio, mes, dia);
                            const fechaDom = new Date(anio, mes, dia + 1);

                            const formatosABuscar = [];
                            [fechaLun, fechaMar, fechaMie, fechaJue, fechaVie, fechaSab, fechaDom].forEach(f => {
                                const d = f.getDate();
                                const m = f.getMonth() + 1;
                                const yFull = f.getFullYear();
                                const yShort = yFull % 100;
                                // Formatos comunes: d/m/yy, dd-mm-yyyy, d-m-yyyy
                                formatosABuscar.push(`${d}/${m}/${yShort}`);
                                formatosABuscar.push(`${String(d).padStart(2, '0')}-${String(m).padStart(2, '0')}-${yFull}`);
                                formatosABuscar.push(`${d}-${m}-${yFull}`);
                            });

                            const partido = todosLosPartidos.find(p => formatosABuscar.includes(p.fecha));
                            const nombrePartidoCalendario = teamName == "FC Cartagena" ? "Cartagena" : teamName == "SD Eibar B" ? "Eibar B" : teamName == "CD Derio" ? "CD Derio" : "INDARTSU";

                            if (partido) {
                                elemento.style.border = (esHoySabado || esHoyDomingo) ? "1px solid white" : "1px solid #ff4444";
                                
                                const esCasa = partido.equipo_1.toLowerCase().includes(nombrePartidoCalendario.toLowerCase());
                                const iconoCasa = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="flex-shrink:0;"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`;
                                const iconoAvion = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="flex-shrink:0; transform: rotate(45deg);"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>`;
                                const icono = esCasa ? iconoCasa : iconoAvion;
                                const nombreRival = esCasa ? partido.equipo_2 : partido.equipo_1;
                                const nombreRivalLimpio = formatearNombreEquipo(nombreRival).replace(/"/g, "");

                                const infoContenedor = document.createElement("div");
                                // Ajustamos el color del VS y texto si el fondo es rojo
                                const colorVs = (esHoySabado || esHoyDomingo) ? "white" : "#ff4444";
                                infoContenedor.style.cssText = "font-size: 0.65em; display: flex; flex-direction: row; align-items: center; justify-content: space-around; gap: 3px; width: 100%; padding: 2px; padding-top: 8px;";
                                infoContenedor.innerHTML = `
                                    <span style="font-size: 1.2em; flex-shrink: 0;">${icono}</span>
                                    <span style="color: ${colorVs}; font-weight: bold; flex-shrink: 0;">vs</span>
                                    <span style="font-weight: bold; white-space: normal; line-height: 1.1; text-align: center; word-break: break-word; width: auto; max-width: fit-content;">
                                      ${nombreRivalLimpio}
                                    </span>
                                `;
                                elemento.appendChild(infoContenedor);
                            }

                            if (dia + 1 <= ultimoDiaMes) dia++;
                            grid.appendChild(elemento);
                        }
                    } else {
                        // Días de diario
                        if (dSemana !== 0) {
                            elemento.innerText = dia;
                            elemento.style.aspectRatio = "1 / 1.4";
                        } else {
                            elemento.style.aspectRatio = "1.6 / 1";
                        }
                        elemento.style.backgroundColor = "#333333";
                        elemento.style.display = "flex";
                        elemento.style.alignItems = "center";
                        elemento.style.justifyContent = "center";
                        elemento.style.fontSize = "0.85em";
                        elemento.style.borderRadius = "4px";

                        if (dia === 1) elemento.style.gridColumnStart = startColumn;

                        if (dia === HOY.getDate() && mes === HOY.getMonth() && anio === HOY.getFullYear()) {
                            elemento.style.backgroundColor = "#ff4444";
                            elemento.style.fontWeight = "bold";
                        }
                        grid.appendChild(elemento);
                    }
                }
                containerCalendario.appendChild(grid);

                document.getElementById("prevMes").onclick = () => {
                    fechaActual.setMonth(fechaActual.getMonth() - 1);
                    renderizarCalendario();
                };
                document.getElementById("nextMes").onclick = () => {
                    fechaActual.setMonth(fechaActual.getMonth() + 1);
                    renderizarCalendario();
                };
            }
            renderizarCalendario();
        }
    } catch (error) {
        console.error("Error al cargar calendario:", error);
    }
  }
  
  function formatearNombreEquipo(texto) {
    if (!texto) return "";

    return texto.toLowerCase().split(' ').map(palabra => {
        // 1. Si contiene comillas
        // 2. Si la longitud es de 1 a 3 caracteres (ej: "CD", "SD", "ZAR")
        if (palabra.includes('"') || (palabra.length >= 1 && palabra.length <= 3 && palabra.toLowerCase() != "la" && palabra.toLowerCase() != "ona" && palabra.toLowerCase() != "san")) {
            return palabra.toUpperCase();
        }

        // Para el resto (palabras largas), solo la primera en mayúscula
        return palabra.charAt(0).toUpperCase() + palabra.slice(1);
    }).join(' ');
  }

  function cargarColor(posicion) {
    if (posicion >= 17) {
      return "#552222";
    } else if (posicion <= 2) {
      return "#113311";
    } else {
      return "#333333";
    }
  }

  function cargarColorCart(posicion) {
    if (posicion >= 16) {
      return "#552222";
    } else if (posicion <= 1) {
      return "#113311";
    } else if (posicion <= 5) {
      return "#448844"
    } else {
      return "#333333";
    }
  }

  function cargarColorPref(posicion, equipo) {
    if (equipo == "SD Eibar B") {
      if (posicion >= 14) {
        return "#552222";
      } else if (posicion <= 1) {
        return "#113311";
      } else if (posicion == 13) {
        return "#CCAA55"
      } else if (posicion <= 5) {
        return "#448844"
      } else {
        return "#333333";
      }
    } else if (equipo == "CD Derio") {
      if (posicion >= 16) {
        return "#552222";
      } else if (posicion <= 1) {
        return "#113311";
      } else if (posicion <= 5) {
        return "#448844"
      } else {
        return "#333333";
      }
    }
  }

  cargarEquipo();
</script>
  
</body>
</html>